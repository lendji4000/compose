<?php

/**
 * EiSubjectMessage
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    kalifastRobot
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class EiSubjectMessage extends BaseEiSubjectMessage
{     
    private $direct_parent=null;
    public function getParentId()
    {
      if (!$this->getNode()->isValidNode() || $this->getNode()->isRoot())
      {
        return null;
      }
      $parent = $this->getNode()->getParent();
      return $parent['id'];
    }
    
    public function setDirectParent(EiSubjectMessage $parent){
        $this->direct_parent=$parent; 
        $this->setRootId($parent->getId());
    }
    public function getDirectParent(){
        return $this->direct_parent;
    }
    
    /* Surcharge de la méthode de sauvegarde d'un noeud dans l'arbre des discussions sur un sujet */
    
    public function save(\Doctrine_Connection $conn = null){
    if ($conn == null)
            $conn = Doctrine_Manager::connection();

        try {
            $conn->beginTransaction();  
            if ($this->isNew()): //On assigne le bug au créateur  
                
                //$ret= parent::save($conn);  
                   //On récupère le noeud parent dans lequel on souhaite ajouter . 
                    if(($parent=$this->getDirectParent())==null): //Insertion d'une nouvelle racine
                        $rgt=1; $level=0; $root_id=null;
                        else: 
                            $rgt=$parent->getRgt(); 
                            $level=$parent->getLevel()+1;
                            $root_id=$parent->getRootId();
                    endif;
                    if($root_id!=null): // L element inséré n'est pas une racine 
                        $conn->execute("update ei_subject_message SET rgt = rgt + 2 WHERE rgt >= ".$rgt." And root_id=".$root_id);
                        $conn->execute("update ei_subject_message SET lft = lft + 2 WHERE lft >= ".$rgt." And root_id=".$root_id);  
                    endif;
                    
                    $this->setRootId($root_id);
                    $this->setLft($rgt);
                    $this->setRgt($rgt+1);
                    $this->setLevel($level);
                    $ret= parent::save($conn);
//                    $conn->insert($this->getTable(),array(
//                        'guard_id' => $this->getGuardId(),
//                        'subject_id' => $this->getSubjectId(),
//                        'message_type_id' => $this->getMessageTypeId(),
//                        'message' => $this->getMessage(),
//                        'type' => $this->getType(),
//                        'position' => 0,
//                        'created_at' => date('Y-m-d H:i:s'),
//                        'updated_at' => date('Y-m-d H:i:s'),
//                        'root_id' => $root_id,
//                        'lft' => $rgt,
//                        'rgt' => $rgt+1,
//                        'level' => $level,
//                    ));
                    if($root_id==null): //Insertion d'un noeud racine 
                        $conn->execute("update ei_subject_message SET root_id = LAST_INSERT_ID() WHERE id= LAST_INSERT_ID()");
                    endif;
                    //throw new Exception($conn->lastInsertId('EiSubjectMessage'));
                else:
                        $ret= parent::save($conn);
                endif;  
            $conn->commit(); 
            return true ;
        } catch (Exception $e) {
            $conn->rollback();
            throw $e;
        }    
    }
}
