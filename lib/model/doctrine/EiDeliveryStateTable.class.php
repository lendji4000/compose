<?php

/**
 * EiDeliveryStateTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class EiDeliveryStateTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object EiDeliveryStateTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('EiDeliveryState');
    }
    //Récupération de la requête pour les statuts de livraison d'un projet
    public function getDeliveryStateForProjectQuery($project_id, $project_ref,Doctrine_Connection $conn=null){
       if($conn==null) $conn = Doctrine_Manager::connection();  
       return $conn->createQuery()->from('EiDeliveryState')
             ->where('project_id= ? And project_ref=? ',
                     array($project_id,$project_ref)) ;
    }
    
    //Création des statuts de livraison  s'ils n'existent pas encore
    public function createDefaultDeliveryStates($project_id, $project_ref,$conn){
        if($conn==null) $conn = Doctrine_Manager::connection(); 
        
        $states=$conn->createQuery()->from('EiDeliveryState')
             ->where('project_id= ? And project_ref=? ',array($project_id,$project_ref)) 
             ->execute();
        
        if(count($states)==0){  // Alors aucun statut n'existe et dans ce cas on crée ceux par défaut
          $this->createState($project_id, $project_ref, 'Open','#36a9e1',1,1,0,$conn) ;
          $this->createState($project_id, $project_ref, 'Closed','#D8473D',0,0,1,$conn) ; 
          return 1;
        }
       return 0;     
    }
    
    //Création d'un statut de livraison pour un projet donné
    public function createState($project_id, $project_ref,$state,$color_code,$display_in_home_page,$display_in_search,$close_state,$conn){
        if($conn==null) $conn = Doctrine_Manager::connection();
        $conn->insert($this->getInstance(),
                array('name'=>$state,
                      'color_code' => $color_code,
                      'display_in_home_page'=>$display_in_home_page,
                      'display_in_search'=>$display_in_search,
                      'close_state'=>$close_state,
                      'project_id' =>$project_id,
                      'project_ref' => $project_ref,
                      'created_at'=> date('Y-m-d H:i:s'),
                      'updated_at' => date('Y-m-d H:i:s')));
    }
    
    /* Récupération de la liste déroulante des statuts de livraison pour la recherche */
    public function getDeliveryStateForSearchBox(EiProjet $ei_project,  Doctrine_Connection $conn=null){
        if($conn==null) $conn = Doctrine_Manager::connection();  
        //Récupération des status de livraison du projet
        $deliveryStates=$conn->createQuery()->from('EiDeliveryState')
             ->where('project_id= ? And project_ref=? ',array($ei_project->getProjectId(),$ei_project->getRefId())) 
             ->execute();
        $stateTab=array();
        if(count($deliveryStates)>0):
            foreach($deliveryStates as $deliveryState):
                $stateTab[$deliveryState->getId()]=$deliveryState->getName();
            endforeach;
        endif;
        return $stateTab;
    }
}