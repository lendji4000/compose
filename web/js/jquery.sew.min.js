(function(d,f,b){var h=function(j,k){j.text(k.val)};var a=[];var e="sew",g=f.document,c={token:"@",elementFactory:h,values:[],unique:false,repeat:true};function i(k,j){this.element=k;this.$element=d(k);this.$itemList=d(i.MENU_TEMPLATE);this.options=d.extend({},c,j);this.reset();this._defaults=c;this._name=e;this.expression=new RegExp("(?:^|\\b|\\s)"+this.options.token+"([\\w.]*)$");this.cleanupHandle=null;this.init()}i.MENU_TEMPLATE="<div class='-sew-list-container' style='display: none; position: absolute;'><ul class='-sew-list'></ul></div>";i.ITEM_TEMPLATE='<li class="-sew-list-item"></li>';i.KEYS=[40,38,13,27,9];i.prototype.init=function(){if(this.options.values.length<1){return}this.$element.bind("keyup",d.proxy(this.onKeyUp,this)).bind("keydown",d.proxy(this.onKeyDown,this)).bind("focus",d.proxy(this.renderElements,this,this.options.values)).bind("blur",d.proxy(this.remove,this))};i.prototype.reset=function(){if(this.options.unique){this.options.values=i.getUniqueElements(this.options.values)}this.index=0;this.matched=false;this.dontFilter=false;this.lastFilter=b;this.filtered=this.options.values.slice(0)};i.prototype.next=function(){this.index=(this.index+1)%this.filtered.length;this.hightlightItem()};i.prototype.prev=function(){this.index=(this.index+this.filtered.length-1)%this.filtered.length;this.hightlightItem()};i.prototype.select=function(){this.replace(this.filtered[this.index].val);this.hideList()};i.prototype.remove=function(){this.$itemList.fadeOut("slow");this.cleanupHandle=f.setTimeout(d.proxy(function(){this.$itemList.remove()},this),1000)};i.prototype.replace=function(n){var o=this.$element.getCursorPosition();var p=o===1?"":"";var k=this.getText();var q=k.substring(0,o);q=q.replace(this.expression,p+this.options.token+n);var l=k.substring(o,k.length);var m=l.match(/^\s/)?"":"";var j=q+m+l;this.setText(j);this.$element.setCursorPosition(q.length+1)};i.prototype.hightlightItem=function(){this.$itemList.find(".-sew-list-item").removeClass("selected");var j=this.$itemList.find(".-sew-list-item").parent();var l=this.filtered[this.index].element.addClass("selected");var k=l.position().top;j.scrollTop(j.scrollTop()+k)};i.prototype.renderElements=function(k){d("body").append(this.$itemList);var j=this.$itemList.find("ul").empty();k.forEach(d.proxy(function(n,m){var l=d(i.ITEM_TEMPLATE);this.options.elementFactory(l,n);n.element=l.appendTo(j).bind("click",d.proxy(this.onItemClick,this,n)).bind("mouseover",d.proxy(this.onItemHover,this,m))},this));this.index=0;this.hightlightItem()};i.prototype.displayList=function(){if(!this.filtered.length){return}this.$itemList.show();var j=this.$element;var k=this.$element.offset();var l=j.getCaretPosition();this.$itemList.css({left:k.left+l.left,top:k.top+l.top})};i.prototype.hideList=function(){this.$itemList.hide();this.reset()};i.prototype.filterList=function(l){if(l==this.lastFilter){return}this.lastFilter=l;this.$itemList.find(".-sew-list-item").remove();var j=this.options.values;var k=this.filtered=j.filter(d.proxy(function(m){var n=new RegExp("\\W*"+this.options.token+m.val+"(\\W|$)");if(!this.options.repeat&&this.getText().match(n)){return false}return l===""||m.val.toLowerCase().indexOf(l.toLowerCase())>=0||(m.meta||"").toLowerCase().indexOf(l.toLowerCase())>=0},this));if(k.length){this.renderElements(k);this.$itemList.show()}else{this.hideList()}};i.getUniqueElements=function(j){var k=[];j.forEach(function(l){var m=k.map(function(n){return n.val}).indexOf(l.val)>=0;if(m){return}k.push(l)});return k};i.prototype.getText=function(){return(this.$element.val()||this.$element.text())};i.prototype.setText=function(j){if(this.$element.prop("tagName").match(/input|textarea/i)){this.$element.val(j)}else{j=d("<span>").text(j).html().replace(/\s/g,"&nbsp");this.$element.html(j)}};i.prototype.onKeyUp=function(l){var k=this.$element.getCursorPosition();var m=this.getText().substring(0,k);var j=m.match(this.expression);if(!j&&this.matched){this.matched=false;this.dontFilter=false;this.hideList();return}if(j&&!this.matched){this.displayList();this.lastFilter="\n";this.matched=true}if(j&&!this.dontFilter){this.filterList(j[1])}};i.prototype.onKeyDown=function(j){var k=this.$itemList.is(":visible");if(!k||(i.KEYS.indexOf(j.keyCode)<0)){return}switch(j.keyCode){case 9:case 13:this.select();break;case 40:this.next();break;case 38:this.prev();break;case 27:this.$itemList.hide();this.dontFilter=true;break}j.preventDefault()};i.prototype.onItemClick=function(j,k){if(this.cleanupHandle){f.clearTimeout(this.cleanupHandle)}this.replace(j.val);this.hideList();this.$element.trigger("sew.element.click",[j])};i.prototype.onItemHover=function(j,k){this.index=j;this.hightlightItem()};d.fn[e]=function(j){return this.each(function(k){if(!d.data(this,"plugin_"+e)){a[k]=new i(this,j);d.data(this,"plugin_"+e,a)}})};d.fn.sew.refreshValues=function(j){for(key in a){a[key].options.values=j}}}(jQuery,window));